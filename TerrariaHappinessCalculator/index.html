<!doctype HTML>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.20.0/vuedraggable.umd.min.js"></script>
    <script src="model.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="images/Favicon.ico">
    <title>Terraria NPC Happiness Calculator by Dodo</title>
    <meta name="Keywords" content="Terraria,NPC,Happiness,Dodo,McjMzn,Journey's End, 1.4.1, Calculator">
</head>
<body>
    <div class="header">
        <span>Terraria NPC Happiness Calculator</span>
        <span class="secondary">by Dodo</span>
        <br/>
        <span class="secondary" style="font-size: 13px;">Based on data from the <a href="https://terraria.gamepedia.com/NPCs#Happiness">gamepedia</a> accessed on 26.10.2020. Calculator assumes that towns are at least 240 tiles away from each other. Displayed percantages are shop price modifiers, so the lower, the better. Pylons are sold at <span class="happy">85%</span> and below.</span>
    </div>
    <div id="app"></div>
</body>
<script>
    Vue.component('town', {
        template: `
        <div class="ui-frame">
            <div class="biomes">
                <img width="35px" v-for='biome in availableBiomes' :src="'images/' + biome + '.png'" :title="biome" :class="{ disabled: !town.biomes.includes(biome) }" v-on:click="toggleBiome(biome)" style="cursor: pointer;" />
            </div>
            
            <draggable v-model="town.npcs" group="npcs" class="town-npcs" @add="npcSettled">
                <div class="npc" v-for='npc in town.npcs' :key="npc.Name">
                    <img :src="'images/' + npc.Name.replace(' ', '') + '.png'" class="img" />
                    <div class="name">{{npc.Name}}</div>
                    <div :class="{ happy: npc.happiness <= 85, sad: npc.happiness > 100 }">{{npc.happiness}}%</div>
                    <div class="remove" v-on:click="removeNpc(npc)" title="Remove from town">X</div>
                    <div class="tooltip">
                        <div v-if="npc.isPrincess">Loves: everyone</div>
                        <div v-else>Loves: <img v-for="love in npc.Loved" :src="'images/emotes/'+love.replace(' ', '')+'.png'" :title="love"></div>
                        <div>Likes: <img v-for="like in npc.Liked" :src="'images/emotes/'+like.replace(' ', '')+'.png'" :title="like"></div>
                        <div>Dislikes: <img v-for="dislike in npc.Disliked" :src="'images/emotes/'+dislike.replace(' ', '')+'.png'" :title="dislike"></div>
                        <div>Hates: <img v-for="hate in npc.Hated" :src="'images/emotes/'+hate.replace(' ', '')+'.png'" :title="hate"></div>
                        <div>Loved by: <img v-for="love in npc.LovedBy" :src="'images/emotes/'+love.replace(' ', '')+'.png'" :title="love"></div>
                        <div v-if="npc.isPrincess">Liked by: everyone</div>
                        <div v-else>Liked by: <img v-for="like in npc.LikedBy" :src="'images/emotes/'+like.replace(' ', '')+'.png'" :title="like"></div>
                        <div>Disliked by: <img v-for="dislike in npc.DislikedBy" :src="'images/emotes/'+dislike.replace(' ', '')+'.png'" :title="dislike"></div>
                        <div>Hated by: <img v-for="hate in npc.HatedBy" :src="'images/emotes/'+hate.replace(' ', '')+'.png'" :title="hate"></div>
                    </div>
                </div>
            </draggable>
        </div>
        `,
        props: {
            town: Object
        },
        methods: {
            removeNpc(npc) {
                this.$emit('remove', this.town, npc);
            },
            toggleBiome: function(biome) {
                let index = this.town.biomes.indexOf(biome);
                if (index < 0)
                {
                    this.town.biomes.push(biome);
                } else {
                    this.town.biomes.splice(index, 1);
                }
            },
            imageUrl(npc) {
                return 'images/' + npc.Name.replace(' ', '') + '.png';
            },
            npcSettled(){
                // unfortunately vue-draggable don't seem to provide a way to determine who exactly was added
                // updating town for everyone as a workaround, for existing npcs this shouldn't do anything
                this.town.npcs.forEach(npc => npc.town = this.town);
            }
        },
        computed: {
            availableBiomes: function() {
                return Object.values(Biomes);
            }
        }
    });
    
    let app = new Vue({
        el: '#app',
        template:`
        <div class="app">
            <draggable v-model="towns" group="towns" class="towns">
                <town v-for="town in towns" :town="town" :key="town.id" @remove="evict"></town>
                <div slot="footer" v-on:click="addTown" class="ui-frame transparent add">
                    <div>Add next town</div>
                </div>
            </draggable>
            <draggable v-model="homeless" group="npcs" class="homeless" @add="refreshHomeless">
                <div class="npc" v-for='npc in homeless' :key="npc.Name">
                    <img :src="'images/' + npc.Name.replace(' ', '') + '.png'" class="img" />
                    <div class="name">{{npc.Name}}</div>
                </div>
            </draggable>
        </div>
        `,
        data: {
            homeless: NpcModels,
            towns: [{
                id: Date.now(), //use date of creation as an unique id
                npcs: [],
                biomes: []
            }]
        },
        methods: {
            addTown(){
                this.towns.push({
                    id: Date.now(), //use date of creation as an unique id
                    npcs: [],
                    biomes: []
                });
            },
            evict(town, npc){
                npc.town = null;
                town.npcs.splice(town.npcs.indexOf(npc), 1);
                this.homeless.push(npc);
            },
            refreshHomeless(){
                // unfortunately vue-draggable don't seem to provide a way to determine who exactly was added
                // updating town for everyone as a workaround, for existing npcs this shouldn't do anything
                this.homeless.forEach(npc => npc.town = null);
            }
        }
    });
</script>
</html>